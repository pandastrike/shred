<!DOCTYPE html>  <html> <head>   <title>request.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="examples.html">                 examples.js               </a>                                           <a class="source" href="shred.html">                 shred.js               </a>                                           <a class="source" href="content.html">                 content.js               </a>                                           <a class="source" href="headers.html">                 headers.js               </a>                                           <a class="source" href="parseUri.html">                 parseUri.js               </a>                                           <a class="source" href="request.html">                 request.js               </a>                                           <a class="source" href="response.html">                 response.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               request.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The request object encapsulates a request, creating a Node.js HTTP request and
then handling the response.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">HTTP</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">HTTPS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">parseUri</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./parseUri&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Emitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>
  <span class="p">,</span> <span class="nx">sprintf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;sprintf&quot;</span><span class="p">).</span><span class="nx">sprintf</span>
  <span class="p">,</span> <span class="nx">Response</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./response&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">HeaderMixins</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./mixins/headers&quot;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Content</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;./content&quot;</span><span class="p">)</span>
<span class="p">;</span>

<span class="kd">var</span> <span class="nx">STATUS_CODES</span> <span class="o">=</span> <span class="nx">HTTP</span><span class="p">.</span><span class="nx">STATUS_CODES</span> <span class="o">||</span> <span class="p">{</span>
    <span class="mi">100</span> <span class="o">:</span> <span class="s1">&#39;Continue&#39;</span><span class="p">,</span>
    <span class="mi">101</span> <span class="o">:</span> <span class="s1">&#39;Switching Protocols&#39;</span><span class="p">,</span>
    <span class="mi">102</span> <span class="o">:</span> <span class="s1">&#39;Processing&#39;</span><span class="p">,</span> <span class="c1">// RFC 2518, obsoleted by RFC 4918</span>
    <span class="mi">200</span> <span class="o">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span>
    <span class="mi">201</span> <span class="o">:</span> <span class="s1">&#39;Created&#39;</span><span class="p">,</span>
    <span class="mi">202</span> <span class="o">:</span> <span class="s1">&#39;Accepted&#39;</span><span class="p">,</span>
    <span class="mi">203</span> <span class="o">:</span> <span class="s1">&#39;Non-Authoritative Information&#39;</span><span class="p">,</span>
    <span class="mi">204</span> <span class="o">:</span> <span class="s1">&#39;No Content&#39;</span><span class="p">,</span>
    <span class="mi">205</span> <span class="o">:</span> <span class="s1">&#39;Reset Content&#39;</span><span class="p">,</span>
    <span class="mi">206</span> <span class="o">:</span> <span class="s1">&#39;Partial Content&#39;</span><span class="p">,</span>
    <span class="mi">207</span> <span class="o">:</span> <span class="s1">&#39;Multi-Status&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">300</span> <span class="o">:</span> <span class="s1">&#39;Multiple Choices&#39;</span><span class="p">,</span>
    <span class="mi">301</span> <span class="o">:</span> <span class="s1">&#39;Moved Permanently&#39;</span><span class="p">,</span>
    <span class="mi">302</span> <span class="o">:</span> <span class="s1">&#39;Moved Temporarily&#39;</span><span class="p">,</span>
    <span class="mi">303</span> <span class="o">:</span> <span class="s1">&#39;See Other&#39;</span><span class="p">,</span>
    <span class="mi">304</span> <span class="o">:</span> <span class="s1">&#39;Not Modified&#39;</span><span class="p">,</span>
    <span class="mi">305</span> <span class="o">:</span> <span class="s1">&#39;Use Proxy&#39;</span><span class="p">,</span>
    <span class="mi">307</span> <span class="o">:</span> <span class="s1">&#39;Temporary Redirect&#39;</span><span class="p">,</span>
    <span class="mi">400</span> <span class="o">:</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span>
    <span class="mi">401</span> <span class="o">:</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span>
    <span class="mi">402</span> <span class="o">:</span> <span class="s1">&#39;Payment Required&#39;</span><span class="p">,</span>
    <span class="mi">403</span> <span class="o">:</span> <span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span>
    <span class="mi">404</span> <span class="o">:</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span>
    <span class="mi">405</span> <span class="o">:</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span>
    <span class="mi">406</span> <span class="o">:</span> <span class="s1">&#39;Not Acceptable&#39;</span><span class="p">,</span>
    <span class="mi">407</span> <span class="o">:</span> <span class="s1">&#39;Proxy Authentication Required&#39;</span><span class="p">,</span>
    <span class="mi">408</span> <span class="o">:</span> <span class="s1">&#39;Request Time-out&#39;</span><span class="p">,</span>
    <span class="mi">409</span> <span class="o">:</span> <span class="s1">&#39;Conflict&#39;</span><span class="p">,</span>
    <span class="mi">410</span> <span class="o">:</span> <span class="s1">&#39;Gone&#39;</span><span class="p">,</span>
    <span class="mi">411</span> <span class="o">:</span> <span class="s1">&#39;Length Required&#39;</span><span class="p">,</span>
    <span class="mi">412</span> <span class="o">:</span> <span class="s1">&#39;Precondition Failed&#39;</span><span class="p">,</span>
    <span class="mi">413</span> <span class="o">:</span> <span class="s1">&#39;Request Entity Too Large&#39;</span><span class="p">,</span>
    <span class="mi">414</span> <span class="o">:</span> <span class="s1">&#39;Request-URI Too Large&#39;</span><span class="p">,</span>
    <span class="mi">415</span> <span class="o">:</span> <span class="s1">&#39;Unsupported Media Type&#39;</span><span class="p">,</span>
    <span class="mi">416</span> <span class="o">:</span> <span class="s1">&#39;Requested Range Not Satisfiable&#39;</span><span class="p">,</span>
    <span class="mi">417</span> <span class="o">:</span> <span class="s1">&#39;Expectation Failed&#39;</span><span class="p">,</span>
    <span class="mi">418</span> <span class="o">:</span> <span class="s1">&#39;I\&#39;m a teapot&#39;</span><span class="p">,</span> <span class="c1">// RFC 2324</span>
    <span class="mi">422</span> <span class="o">:</span> <span class="s1">&#39;Unprocessable Entity&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">423</span> <span class="o">:</span> <span class="s1">&#39;Locked&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">424</span> <span class="o">:</span> <span class="s1">&#39;Failed Dependency&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">425</span> <span class="o">:</span> <span class="s1">&#39;Unordered Collection&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">426</span> <span class="o">:</span> <span class="s1">&#39;Upgrade Required&#39;</span><span class="p">,</span> <span class="c1">// RFC 2817</span>
    <span class="mi">500</span> <span class="o">:</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span>
    <span class="mi">501</span> <span class="o">:</span> <span class="s1">&#39;Not Implemented&#39;</span><span class="p">,</span>
    <span class="mi">502</span> <span class="o">:</span> <span class="s1">&#39;Bad Gateway&#39;</span><span class="p">,</span>
    <span class="mi">503</span> <span class="o">:</span> <span class="s1">&#39;Service Unavailable&#39;</span><span class="p">,</span>
    <span class="mi">504</span> <span class="o">:</span> <span class="s1">&#39;Gateway Time-out&#39;</span><span class="p">,</span>
    <span class="mi">505</span> <span class="o">:</span> <span class="s1">&#39;HTTP Version not supported&#39;</span><span class="p">,</span>
    <span class="mi">506</span> <span class="o">:</span> <span class="s1">&#39;Variant Also Negotiates&#39;</span><span class="p">,</span> <span class="c1">// RFC 2295</span>
    <span class="mi">507</span> <span class="o">:</span> <span class="s1">&#39;Insufficient Storage&#39;</span><span class="p">,</span> <span class="c1">// RFC 4918</span>
    <span class="mi">509</span> <span class="o">:</span> <span class="s1">&#39;Bandwidth Limit Exceeded&#39;</span><span class="p">,</span>
    <span class="mi">510</span> <span class="o">:</span> <span class="s1">&#39;Not Extended&#39;</span> <span class="c1">// RFC 2774</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The Shred object itself constructs the <code>Request</code> object. You should rarely
need to do this directly.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Request</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logger</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">cookieJar</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cookieJar</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">encoding</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">logCurl</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logCurl</span><span class="p">;</span>
  <span class="nx">processOptions</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">options</span><span class="o">||</span><span class="p">{});</span>
  <span class="nx">createRequest</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>A <code>Request</code> has a number of properties, many of which help with details like
URL parsing or defaulting the port for the request.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperties</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <ul>
<li><strong>url</strong>. You can set the <code>url</code> property with a valid URL string and all the
URL-related properties (host, port, etc.) will be automatically set on the
request object. The source URL is used if the requested URL is missing any URL-related properties.  This allows URLs such as: "/path/1" or "//server/path/2".</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">url</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">return</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;%s://%s:%s%s&quot;</span><span class="p">,</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
          <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">?</span> <span class="s2">&quot;/&quot;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">+</span>
          <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_url</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_url</span> <span class="o">=</span> <span class="nx">parseUri</span><span class="p">(</span><span class="nx">_url</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">_url</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <ul>
<li><strong>headers</strong>. Returns a hash representing the request headers. You can't set
this directly, only get it. You can add or modify headers by using the
<code>setHeader</code> or <code>setHeaders</code> method. This ensures that the headers are
normalized - that is, you don't accidentally send <code>Content-Type</code> and
<code>content-type</code> headers. Keep in mind that if you modify the returned hash,
it will <em>not</em> modify the request headers.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeaders</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <ul>
<li><strong>port</strong>. Unless you set the <code>port</code> explicitly or include it in the URL, it
will default based on the scheme.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">port</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_port</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">===</span> <span class="s2">&quot;https&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nb">window</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="mi">443</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span> <span class="o">=</span> <span class="mi">443</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nb">window</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="mi">80</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">_port</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <ul>
<li><strong>method</strong>. The request method - <code>get</code>, <code>put</code>, <code>post</code>, etc. that will be
used to make the request. Defaults to <code>get</code>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">method</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_method</span><span class="o">||</span><span class="s2">&quot;GET&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <ul>
<li><strong>query</strong>. Can be set either with a query string or a hash (object). Get
will always return a properly escaped query string or null if there is no
query component for the request.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="p">;},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">stringify</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">query</span> <span class="o">+=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">hash</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Remove the last '&amp;'</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">query</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_query</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <ul>
<li><strong>parameters</strong>. This will return the query parameters in the form of a hash
(object).</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">parameters</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">QueryString</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_query</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <ul>
<li><strong>content</strong>. (Aliased as <code>body</code>.) Set this to add a content entity to the
request. Attempts to use the <code>content-type</code> header to determine what to do
with the content value. Get this to get back a <a href="./content.html"><code>Content</code>
object</a>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_body</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Content</span><span class="p">({</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">)</span>
      <span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <ul>
<li><strong>timeout</strong>. Used to determine how long to wait for a response. Does not
distinguish between connect timeouts versus request timeouts. Set either in
milliseconds or with an object with temporal attributes (hours, minutes,
seconds) and convert it into milliseconds. Get will always return
milliseconds.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">timeout</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">;</span> <span class="p">},</span> <span class="c1">// in milliseconds</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">this</span>
        <span class="p">,</span> <span class="nx">milliseconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">timeout</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">timeout</span><span class="o">===</span><span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="nx">milliseconds</span> <span class="o">=</span> <span class="nx">timeout</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">milliseconds</span> <span class="o">=</span> <span class="p">(</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">milliseconds</span><span class="o">||</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
          <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="p">((</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">seconds</span><span class="o">||</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
              <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="p">((</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">minutes</span><span class="o">||</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="p">(</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">hours</span><span class="o">||</span><span class="mi">0</span><span class="p">))))));</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span> <span class="o">=</span> <span class="nx">milliseconds</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <ul>
<li><strong>sslStrict*</strong>. Used to disable to auth check for ssl certificataes,
set to true to use self signed certs</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">sslStrict</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sslStrict</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sslStrict</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">sslStrict</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_sslStrict</span> <span class="o">=</span> <span class="nx">sslStrict</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Alias <code>body</code> property to <code>content</code>. Since the <a href="./content.html">content object</a>
has a <code>body</code> attribute, it's preferable to use <code>content</code> since you can then
access the raw content data using <code>content.body</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span><span class="s2">&quot;content&quot;</span><span class="p">,</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The <code>Request</code> object can be pretty overwhelming to view using the built-in
Node.js inspect method. We want to make it a bit more manageable. This
probably goes <a href="https://github.com/spire-io/shred/issues/2">too far in the other
direction</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inspect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">format_headers</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;Shred Request&gt; &quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">(),</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[</span> <span class="nx">summary</span><span class="p">,</span> <span class="s2">&quot;- Headers:&quot;</span><span class="p">,</span> <span class="nx">headers</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">format_headers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_headers</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Allow chainable 'on's:  shred.get({ ... }).on( ... ).  You can pass in a
single function, a pair (event, function), or a hash:
{ event: function, event: function }</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">eventOrHash</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">emitter</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Pass in a single argument as a function then make it the default response handler</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">eventOrHash</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">eventOrHash</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">eventOrHash</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">eventOrHash</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">eventOrHash</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">eventOrHash</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">eventOrHash</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Add in the header methods. Again, these ensure we don't get the same header
multiple times with different case conventions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">HeaderMixins</span><span class="p">.</span><span class="nx">gettersAndSetters</span><span class="p">(</span><span class="nx">Request</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><code>processOptions</code> is called from the constructor to handle all the work
associated with making sure we do our best to ensure we have a valid request.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">processOptions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Processing request options ..&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>We'll use <code>request.emitter</code> to manage the <code>on</code> event handlers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Emitter</span><span class="p">);</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">agent</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set up the handlers ...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">on</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">on</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">on</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">on</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Make sure we were give a URL or a host</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;request_error&quot;</span><span class="p">,</span>
        <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No url or url options (host, port, etc.)&quot;</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Allow for the <a href="http://www.jmarshall.com/easy/http/#proxies">use of a proxy</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">proxy</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">proxy</span><span class="p">;</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Set the remaining options.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">request</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">query</span><span class="o">||</span><span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="o">||</span><span class="nx">request</span><span class="p">.</span><span class="nx">query</span> <span class="p">;</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>FIXME: options.agent is supposed to be a Node http.Agent, not the
User-Agent string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">request</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span><span class="nx">options</span><span class="p">.</span><span class="nx">agent</span><span class="o">||</span><span class="s2">&quot;Shred&quot;</span><span class="p">);</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">setHeaders</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">cookieJar</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">cookieJar</span><span class="p">.</span><span class="nx">getCookies</span><span class="p">(</span> <span class="nx">CookieAccessInfo</span><span class="p">(</span> <span class="nx">request</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span> <span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cookieString</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">)</span><span class="o">||</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">cookieIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">cookieIndex</span> <span class="o">&lt;</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">cookieIndex</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">cookieString</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">cookieString</span><span class="p">[</span> <span class="nx">cookieString</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;;&#39;</span> <span class="p">)</span>
          <span class="p">{</span>
              <span class="nx">cookieString</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">cookieString</span> <span class="o">+=</span> <span class="nx">cookies</span><span class="p">[</span> <span class="nx">cookieIndex</span> <span class="p">].</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">cookies</span><span class="p">[</span> <span class="nx">cookieIndex</span> <span class="p">].</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;cookie&quot;</span><span class="p">,</span> <span class="nx">cookieString</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>The content entity can be set either using the <code>body</code> or <code>content</code> attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="o">||</span><span class="nx">options</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">body</span><span class="o">||</span><span class="nx">options</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">timeout</span><span class="p">;</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">sslStrict</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">sslStrict</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">sslStrict</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sslStrict</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><code>createRequest</code> is also called by the constructor, after <code>processOptions</code>.
This actually makes the request and processes the response, so <code>createRequest</code>
is a bit of a misnomer.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">createRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">timeoutId</span> <span class="p">;</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Creating request ..&quot;</span><span class="p">);</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">reqParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="s1">&#39;?&#39;</span><span class="o">+</span><span class="nx">request</span><span class="p">.</span><span class="nx">query</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">getHeaders</span><span class="p">(),</span>
    <span class="nx">rejectUnauthorized</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">_sslStrict</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Node's HTTP/S modules will ignore this, but we are using the
browserify-http module in the browser for both HTTP and HTTPS, and this
is how you differentiate the two.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">scheme</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">scheme</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Use a provided agent.  'Undefined' is the default, which uses a global
agent.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">agent</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">agent</span>
  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">logCurl</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logCurl</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">==</span> <span class="s2">&quot;http&quot;</span> <span class="o">?</span> <span class="nx">HTTP</span> <span class="o">:</span> <span class="nx">HTTPS</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Set up the real request using the selected library. The request won't be
sent until we call <code>.end()</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">reqParams</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The "cleanup" event signifies that any timeout or error handlers
that have been set for this request should now be disposed of.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;cleanup&quot;</span><span class="p">);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Received response ..&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>We haven't timed out and we have a response, so make sure we clear the
timeout so it doesn't fire while we're processing the response.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeoutId</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Construct a Shred <code>Response</code> object from the response. This will stream
the response, thus the need for the callback. We can access the response
entity safely once we're in the callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Set up some event magic. The precedence is given first to
status-specific handlers, then to responses for a given event, and then
finally to the more general <code>response</code> handler. In the last case, we
need to first make sure we're not dealing with a a redirect.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">emitter</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">textStatus</span> <span class="o">=</span> <span class="nx">STATUS_CODES</span><span class="p">[</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">]</span> <span class="o">?</span> <span class="nx">STATUS_CODES</span><span class="p">[</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">emitter</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">textStatus</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
          <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">textStatus</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">event</span><span class="p">).</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">isRedirect</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>console.warn("Request has no event listener for status code " + response.status);</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Next, check for a redirect. We simply repeat the request with the URL
given in the <code>Location</code> header. We fire a <code>redirect</code> event.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">isRedirect</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Redirecting to &quot;</span>
            <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">));</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getHeader</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">);</span>
        <span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;redirect&quot;</span><span class="p">);</span>
        <span class="nx">createRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Okay, it's not a redirect. Is it an error of some kind?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">isError</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>It looks like we're good shape. Trigger the <code>success</code> event.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">setMaxListeners</span><span class="p">(</span> <span class="mi">30</span> <span class="p">);</span> <span class="c1">// avoid warnings</span>
  </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>We're still setting up the request. Next, we're going to handle error cases
where we have no response. We don't emit an error event because that event
takes a response. We don't response handlers to have to check for a null
value. However, we <a href="https://github.com/spire-io/shred/issues/3">should introduce a different event
type</a> for this type of error.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">timeoutId</span><span class="p">)</span> <span class="p">{</span> <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;request_error&quot;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span> <span class="p">}</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;cleanup&quot;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>TCP timeouts should also trigger the "response_error" event.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;socket&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">timeout_handler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span> <span class="p">};</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;cleanup&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="nx">timeout_handler</span><span class="p">);</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>This should trigger the "error" event on the raw request, which will
trigger the "response_error" on the shred request.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="nx">timeout_handler</span><span class="p">);</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>We're almost there. Next, we need to write the request entity to the
underlying request object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Streaming body: &#39;&quot;</span> <span class="o">+</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">59</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; ... &quot;</span><span class="p">);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Finally, we need to set up the timeout. We do this last so that we don't
start the clock ticking until the last possible moment.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">timeoutId</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Timeout fired, aborting request ...&quot;</span><span class="p">);</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">emitter</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">request</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>The <code>.end()</code> method will cause the request to fire. Technically, it might
have already sent the headers and body.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">request</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Sending request ...&quot;</span><span class="p">);</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Logs the curl command for the request.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">logCurl</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">getHeaders</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">headerString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">headerString</span> <span class="o">+=</span> <span class="s1">&#39;-H &quot;&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">bodyString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">bodyString</span> <span class="o">+=</span> <span class="s2">&quot;-d &#39;&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">body</span> <span class="o">+</span> <span class="s2">&quot;&#39; &quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;curl &quot;</span> <span class="o">+</span>
    <span class="s2">&quot;-X &quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">+</span> <span class="s2">&quot;://&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="nx">query</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span>
    <span class="nx">headerString</span> <span class="o">+</span>
    <span class="nx">bodyString</span>
  <span class="p">);</span>
<span class="p">};</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Request</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 
